import io
import pandas as pd
from datetime import datetime
from fastapi import UploadFile


def create_test_dataframe() -> pd.DataFrame:
    """
    원본 엑셀 파일이랑 완전히 똑같은 테스트용 DataFrame을 생성함
    """

    # 헤더 부분
    headers = [
        "순번",
        "사이트",
        "수취인명",
        "금액",
        "주문번호",
        "제품명",
        "수량",
        "전화번호1",
        "전화번호2",
        "수취인주소",
        "우편번호",
        "선/착불",
        "상품번호",
        "배송메세지",
        "정산예정금액",
        "서비스이용료",
        "장바구니번호",
        "운송장번호",
        "운임비타입",
        "판매자관리코드",
        "금액[배송비미포함]",
        "배송비",
        "사방넷품번코드",
        "사방넷주문번호",
        "수집상품명",
        "수집옵션",
        "ERP업로드용_모델명",
        "사은품",
    ]

    # 데이터 부분 (헤더 제외 13행)
    test_data = [
        [
            None,
            "[오케이마트]옥션2.0",
            "김동춘",
            "=O2+P2+V2",
            "2522492328",
            "ODM-COLDBAG8(BL) 1개",
            "1",
            "010-0000-0000",
            "010-0000-0000",
            "서울특별시 중랑구 용마산로94길 91 (진로아파트) 101동1205호",
            "021-90",
            "신용",
            "E903387285",
            "부재 시 문 앞에 놓아주세요.",
            "9340",
            "1560",
            "1683617186",
            None,
            "S",
            None,
            "10900",
            "3000",
            "129695",
            "2080694993",
            "30L 쿨러백 보냉가방 도시락가방 캠핑 피크닉 런치백 이유식 아이스 대형 보온 보냉백 ODM-COLDBAG8",
            "색상:블루/0원/1개",
            "ODM-COLDBAG8(BL) 1개",
            None,
        ],
        [
            None,
            "[아이예스]옥션2.0",
            "김동춘",
            "=O2+P2+V2",
            "2522484999",
            "ODM-SLVM2(110-WH) 2개",
            "2",
            "010-0000-0000",
            "010-0000-0000",
            "서울특별시 중랑구 용마산로94길 91 (진로아파트) 101동1205호",
            "021-90",
            "신용",
            "F250406492",
            "부재 시 문 앞에 놓아주세요.",
            "8700",
            "1300",
            "1683611383",
            None,
            "S",
            None,
            "10000",
            "3500",
            "129233",
            "2080695718",
            "남자 의류 쿨링 냉감 여름 민소매티 메쉬 브이넥 무지 남성 나시 티셔츠 ODM-SLVM2",
            "화이트:110/0원/2개",
            "ODM-SLVM2(110-WH) 2개",
            None,
        ],
        [
            None,
            "[오케이마트]옥션2.0",
            "박지연",
            "=O2+P2+V2",
            "2522461879",
            "ODM-BLIND1(40X60-BK) 2개<롤업블라인드> 1개",
            "1",
            "010-0000-0000",
            "010-0000-0000",
            "서울특별시 중랑구 면목로55가길 33-4 .",
            "022-17",
            "신용",
            "E941169583",
            None,
            "8184",
            "636",
            "1683592968",
            None,
            "S",
            None,
            "7740",
            "0",
            "128566",
            "2080694982",
            "1+1 40X60cm 붙이는 블라인드 무타공 암막 햇빛가리개 창문블라인드",
            "BLIND1_40X60_블랙:40X60_블랙/0원/1개",
            "ODM-BLIND1(40X60-BK) 2개<롤업블라인드> 1개",
            None,
        ],
        [
            None,
            "[아이예스]옥션2.0",
            "이명희",
            "=O2+P2+V2",
            "2522583530",
            "OLV-BD68125 1개",
            "1",
            "010-0000-0000",
            "010-0000-0000",
            "서울특별시 금천구 한내로 69-54 (주공14단지아파트) 독산주공14단지아파트 1402동503호",
            "085-97",
            "신용",
            "E454696331",
            None,
            "5860",
            "1040",
            "1683690882",
            None,
            "S",
            None,
            "6900",
            "3000",
            "123789",
            "2080695728",
            "창문 붙이는 블라인드 무타공 암막 햇빛가리개 롤스크린 원룸 거실 베란다 사무실 IY-BD68125",
            None,
            "OLV-BD68125 1개",
            None,
        ],
        [
            None,
            "[오케이마트]옥션2.0",
            "이용덕",
            "=O2+P2+V2",
            "2522627001",
            "469465 1개",
            "1",
            "010-0000-0000",
            "010-0000-0000",
            "서울특별시 금천구 시흥대로2길 60-5 (천록빌라) 125호",
            "086-54",
            "신용",
            "C394337692",
            "배송 전 연락바랍니다.",
            "8470",
            "1430",
            "1683726004",
            None,
            "OCA-360HD",
            None,
            "9900",
            "0",
            "115996",
            "2080695146",
            "OMT 차량용 멀티 자동차 컵홀더 거치대 OCA-360HD",
            None,
            "OCA-360HD 1개",
            None,
        ],
        [
            None,
            "[오케이마트]옥션2.0",
            "이진숙",
            "=O2+P2+V2",
            "2522645715",
            "861704 2개",
            "2",
            "010-0000-0000",
            "010-0000-0000",
            "경기도 김포시 사우로 51 (김포사우아이파크) 109동103호",
            "101-11",
            "신용",
            "E397982325",
            None,
            "13420",
            "2600",
            "1683740884",
            None,
            "OCA-SDP1(BK) (틈새포켓)",
            None,
            "17800",
            "3000",
            "123656",
            "2080695224",
            "차량용 틈새 수납함 가죽 사이드포켓 OCA-SDP1",
            None,
            "OCA-SDP1(BK) 2개",
            None,
        ],
        [
            None,
            "[오케이마트]옥션2.0",
            "이진숙",
            "=O2+P2+V2",
            "2522645716",
            "288789 1개",
            "1",
            "010-0000-0000",
            "010-0000-0000",
            "경기도 김포시 사우로 51 (김포사우아이파크) 109동103호",
            "101-11",
            "신용",
            "B776346113",
            None,
            "5002",
            "308",
            "1683740884",
            None,
            "OSO-T052",
            None,
            "4956",
            "3000",
            "108026",
            "2080695235",
            "OMT 차량용 멀티 2포켓 수납함 수납네트 OSO-T052",
            None,
            "OSO-T052 1개",
            None,
        ],
        [
            None,
            "[클로버프]옥션2.0",
            "곽선숙",
            "=O2+P2+V2",
            "2522543921",
            "ODM-TRAP1<하수구트랩> 1개",
            "1",
            "010-0000-0000",
            "010-0000-0000",
            "경기도 남양주시 화도읍 녹촌로 20(신한토탈아파트) 105동1301호",
            "121-86",
            "신용",
            "E907446528",
            None,
            "5722",
            "278",
            "1683658816",
            None,
            "S",
            None,
            "5376",
            "3000",
            "128089",
            "2080696374",
            "화장실 세면대트랩 마개 팝업 냄새 막힘방지 거름망 배수구 물마개",
            "색상:TRAP1_하수구트랩/0원/1개",
            "ODM-TRAP1 1개",
            None,
        ],
        [
            None,
            "[오케이마트]옥션2.0",
            "문광옥",
            "=O2+P2+V2",
            "2522633520",
            "OLV-CUTL1(GY) 1개",
            "1",
            "010-0000-0000",
            "010-0000-0000",
            "경기도 시흥시 군자로253번길 20 (군자서희스타힐스아파트) 110동1304호",
            "150-04",
            "신용",
            "E241244195",
            "부재 시 문 앞에 놓아주세요.",
            "4720",
            "780",
            "1683731081",
            None,
            "S",
            None,
            "5500",
            "0",
            "122999",
            "2080695174",
            "선정리 찍찍이 테이프 5M 간편컷팅 밴드 전선정리 OLV-CUTL1",
            None,
            "OLV-CUTL1(GY) 1개",
            None,
        ],
        [
            None,
            "[오케이마트]옥션2.0",
            "문광옥",
            "=O2+P2+V2",
            "2522633521",
            "469465 1개",
            "1",
            "010-0000-0000",
            "010-0000-0000",
            "경기도 시흥시 군자로253번길 20 (군자서희스타힐스아파트) 110동1304호",
            "150-04",
            "신용",
            "C394337692",
            "부재 시 문 앞에 놓아주세요.",
            "8470",
            "1430",
            "1683731081",
            None,
            "OCA-360HD",
            None,
            "9900",
            "0",
            "115996",
            "2080695181",
            "OMT 차량용 멀티 자동차 컵홀더 거치대 OCA-360HD",
            None,
            "OCA-360HD 1개",
            None,
        ],
        [
            None,
            "[베이지베이글]옥션2.0",
            "김학수",
            "=O2+P2+V2",
            "2522607659",
            "ODM-TRAP3<하수구트랩> 1개",
            "1",
            "010-0000-0000",
            "010-0000-0000",
            "경기도 의왕시 부곡초등1길 6 (우성6차아파트) 114동.104호",
            "160-98",
            "신용",
            "E903057435",
            "문앞에 놓아주세요",
            "6730",
            "1170",
            "1683710418",
            None,
            "S",
            None,
            "7900",
            "3000",
            "128105",
            "2080696089",
            "국산 냄새제거 벌레차단 하수구트랩 욕실 화장실 자동물빠짐 배수구트랩",
            "색상:TRAP3_하수구트랩/0원/1개",
            "ODM-TRAP3 1개",
            None,
        ],
        [
            None,
            "[오케이마트]옥션2.0",
            "이현숙",
            "=O2+P2+V2",
            "2522539012",
            "OFS-SUNSHADE1<뒷유리-햇빛가리개> 1개",
            "1",
            "010-0000-0000",
            "010-0000-0000",
            "경기도 용인시 기흥구 고매로43번길 32-2 (불곡마을벽산블루밍) 106동 503호",
            "170-84",
            "신용",
            "E941255748",
            None,
            "5990",
            "910",
            "1683654788",
            None,
            "S",
            None,
            "6900",
            "0",
            "128546",
            "2080695004",
            "뒷유리 차량용 햇빛가리개 흡착식 100cm 자외선차단 자동차 창문 햇빛 가리개 OFS-SUNSHADE1",
            None,
            "OFS-SUNSHADE1<뒷유리-햇빛가리개> 1개",
            None,
        ],
        [
            None,
            "[오케이마트]옥션2.0",
            "이현숙",
            "=O2+P2+V2",
            "2522539013",
            "ODM-CUSHION3(레몬)<아이스방석-쿨매트> 1개",
            "1",
            "010-0000-0000",
            "010-0000-0000",
            "경기도 용인시 기흥구 고매로43번길 32-2 (불곡마을벽산블루밍) 106동 503호",
            "170-84",
            "신용",
            "E948787010",
            None,
            "5642",
            "858",
            "1683654788",
            None,
            "S",
            None,
            "6500",
            "0",
            "128706",
            "2080695005",
            "아이스 쿨방석 여름 쿨링매트 의자방석 ODM-CUSHION3",
            "색상:레몬/0원/1개",
            "ODM-CUSHION3(레몬) 1개",
            None,
        ],
    ]

    return pd.DataFrame(test_data, columns=headers)


def create_test_excel_in_memory(df: pd.DataFrame) -> io.BytesIO:
    """
    DataFrame을 받아서 메모리에 기록함 (엑셀 파일로 저장 X)
    """
    
    # 메모리 버퍼 생성
    excel_buffer = io.BytesIO()
    
    # 엑셀 파일을 메모리 버퍼에 쓰기
    with pd.ExcelWriter(excel_buffer, engine='openpyxl') as writer:
        df.to_excel(
            writer,
            sheet_name=f"{datetime.now().strftime('%Y%m%d')}_test_excel",
            index=False
        )
    
    # 버퍼 포인터를 시작점으로 이동
    excel_buffer.seek(0)
    
    return excel_buffer


def create_multipart_upload_file(excel_buffer: io.BytesIO, filename: str = "test_excel.xlsx") -> UploadFile:
    """엑셀 버퍼를 받아서 실제 HTTP 파일 업로드된 것 처럼 생성함"""
    
    excel_buffer.seek(0)
    
    content_type = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
    
    upload_file = UploadFile(
        filename=filename,
        file=excel_buffer,
        size=len(excel_buffer.getvalue()),
        headers={
            "content-disposition": f'form-data; name="file"; filename="{filename}"',
            "content-type": content_type
        }
    )
    
    return upload_file
